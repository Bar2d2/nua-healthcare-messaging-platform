# 🎭 User Flows & Process Documentation

## 📋 Table of Contents
1. [Overview & System Actors](#overview--system-actors)
2. [Patient User Flows](#patient-user-flows)
3. [Admin User Flows](#admin-user-flows)
4. [Doctor User Flows](#doctor-user-flows)
5. [Cross-Role Interactions](#cross-role-interactions)
6. [Technical Implementation Details](#technical-implementation-details)
7. [Error Handling & Edge Cases](#error-handling--edge-cases)

---

## 🎯 Overview & System Actors

### **System Roles**
- **👤 Patient**: Requests prescriptions, manages messages, tracks prescription status
- **👨‍⚕️ Admin**: Generates prescriptions, manages system, handles prescription requests
- **🩺 Doctor**: Communicates with patients, reviews cases (future expansion)

### **Core System Capabilities**
- **Messaging System**: Secure communication between all roles
- **Prescription Workflow**: Lost prescription replacement with payment processing
- **Real-time Updates**: Live status updates via Turbo Streams
- **Payment Processing**: Automated payment with retry mechanisms

---

## 👤 Patient User Flows

### **Flow 1: Lost Prescription Request**

```mermaid
flowchart TD
    A[Patient Login] --> B[Navigate to Prescriptions]
    B --> C[Click 'Request Prescription']
    C --> D[Lost Prescription Modal]
    D --> E{Review Fee & Process}
    E -->|Accept| F[Submit Request]
    E -->|Cancel| B
    F --> G[Payment Processing]
    G --> H{Payment Result}
    H -->|Success| I[Status: Awaiting Admin]
    H -->|Failed| J[Auto Retry 3x]
    J --> K{Retry Success?}
    K -->|Yes| I
    K -->|No| L[Status: Payment Rejected]
    L --> M[Manual Retry Available]
    M --> N[Click Retry Payment]
    N --> O[Retry Confirmation Modal]
    O --> P[Manual Payment Always Succeeds]
    P --> I
    I --> Q[Admin Generates Prescription]
    Q --> R[Status: Ready]
    R --> S[Download PDF Available]
```

**Key UI Components:**
- **Entry Point**: `prescriptions/index.html.erb`
- **Request Modal**: `prescriptions/partials/_lost_prescription_modal.html.erb`
- **Retry Modal**: `prescriptions/partials/_retry_confirmation_modal.html.erb`
- **Status Display**: Real-time updates via Turbo Streams

### **Flow 2: Message Communication**

```mermaid
flowchart TD
    A[Patient Login] --> B[Navigate to Inbox]
    B --> C[View Message List]
    C --> D{Action Choice}
    D -->|Read Message| E[Open Conversation]
    D -->|Compose New| F[New Message Form]
    E --> G[Mark as Read]
    G --> H{Reply Needed?}
    H -->|Yes| I[Reply in Thread]
    H -->|No| J[Return to Inbox]
    F --> K[Select Recipient]
    K --> L[Compose Message]
    L --> M[Send Message]
    M --> N[Real-time Delivery]
    I --> N
    N --> O[Recipient Notification]
```

**Key Features:**
- **Inbox/Outbox**: Separate views for received/sent messages
- **Threading**: Conversation-based message organization
- **Real-time**: Live updates for new messages
- **Read Status**: Automatic read tracking

### **Flow 3: Prescription Status Monitoring**

```mermaid
flowchart TD
    A[Prescription Requested] --> B[Payment Processing]
    B --> C{Payment Status}
    C -->|Pending| D[Show Processing Spinner]
    C -->|Failed| E[Show Retry Button]
    C -->|Success| F[Awaiting Admin Badge]
    E --> G[Manual Retry Flow]
    G --> F
    F --> H[Admin Generates]
    H --> I[Ready Badge]
    I --> J[Download Available]

    style D fill:#fff3cd
    style E fill:#f8d7da
    style F fill:#d4edda
    style I fill:#d1ecf1
```

---

## 👨‍⚕️ Admin User Flows

### **Flow 1: Prescription Generation Workflow**

```mermaid
flowchart TD
    A[Admin Login] --> B[Check Inbox]
    B --> C[New Prescription Request]
    C --> D[Open Conversation]
    D --> E[Review Request Details]
    E --> F[Click 'Generate & Send']
    F --> G[Processing State]
    G --> H[PDF Generation]
    H --> I[Send to Patient]
    I --> J[Update Status to Ready]
    J --> K[Real-time Status Broadcast]
    K --> L[Patient Notification]

    style G fill:#fff3cd
    style J fill:#d4edda
```

**Key Components:**
- **Admin Inbox**: Same interface with admin-specific features
- **Action Button**: `messages/partials/conversation/_prescription_action_button.html.erb`
- **Status Badge**: `messages/partials/conversation/_prescription_badge.html.erb`
- **Processing UI**: Spinner and status updates

### **Flow 2: System Monitoring**

```mermaid
flowchart TD
    A[Admin Dashboard] --> B[Monitor Inbox]
    B --> C{New Requests?}
    C -->|Yes| D[Process Requests]
    C -->|No| E[Check System Status]
    D --> F[Generate Prescriptions]
    F --> G[Update Patient Status]
    G --> B
    E --> H[Review Metrics]
    H --> B
```

---

## 🩺 Doctor User Flows

### **Flow 1: Patient Communication**

```mermaid
flowchart TD
    A[Doctor Login] --> B[Access Inbox]
    B --> C[Review Patient Messages]
    C --> D[Respond to Inquiries]
    D --> E[Send Medical Advice]
    E --> F[Patient Receives Response]

    style E fill:#e7f3ff
```

**Note**: Doctor role is currently implemented for future expansion with same messaging interface.

---

## 🔄 Cross-Role Interactions

### **Complete Prescription Lifecycle**

```mermaid
sequenceDiagram
    participant P as Patient
    participant S as System
    participant A as Admin

    P->>S: Request Lost Prescription
    S->>S: Process Payment
    alt Payment Success
        S->>A: Notify Admin (Inbox)
        S->>P: Status: Awaiting Admin
        A->>S: Generate & Send Prescription
        S->>P: Status: Ready + PDF
        P->>S: Download Prescription
    else Payment Failed
        S->>P: Status: Payment Rejected
        P->>S: Manual Retry Payment
        S->>S: Process Retry (Always Success)
        S->>A: Notify Admin (Inbox)
        S->>P: Status: Awaiting Admin
    end
```

### **Real-time Communication Flow**

```mermaid
sequenceDiagram
    participant U1 as User 1
    participant TS as Turbo Streams
    participant U2 as User 2

    U1->>TS: Send Message
    TS->>U2: Live Update (Inbox)
    U2->>TS: Read Message
    TS->>U1: Read Status Update
    TS->>U2: Unread Count Update
```

---

## ⚙️ Technical Implementation Details

### **Payment Processing Architecture**

```mermaid
flowchart TD
    A[Payment Request] --> B[FlakyPaymentProvider]
    B --> C{New Payment?}
    C -->|Yes| D[Counter Check]
    D --> E{Every 5th?}
    E -->|Yes| F[Fail Payment]
    E -->|No| G[Success Payment]
    C -->|Retry| H[Always Success]
    F --> I[Sidekiq Auto-retry]
    I --> J{Retries Left?}
    J -->|Yes| K[Wait 10s + Retry]
    J -->|No| L[Mark Failed]
    K --> H
    G --> M[Mark Successful]
    H --> M
    L --> N[Show Manual Retry]
    M --> O[Continue Workflow]
```

### **Broadcasting Strategy**

```mermaid
flowchart TD
    A[User Action] --> B{Sync or Async?}
    B -->|Critical| C[Immediate Broadcast]
    B -->|Background| D[Enqueue Job]
    C --> E[Turbo Stream Update]
    D --> F[Background Processing]
    F --> G[Batch Broadcasts]
    G --> E
    E --> H[Real-time UI Update]
```

### **State Management**

| Prescription Status | Payment Status | UI Display | Available Actions |
|-------------------|----------------|------------|------------------|
| `requested` | `pending` | "Processing Payment..." + Spinner | None (auto-retry) |
| `requested` | `successful` | "Awaiting Admin" + Warning Badge | None |
| `payment_rejected` | `failed` | "Payment Failed" + Danger Badge | "Retry Payment" |
| `ready` | `successful` | "Ready" + Success Badge | "Download PDF" |

---

## 🚨 Error Handling & Edge Cases

### **Payment Failure Scenarios**

1. **Network Timeout**: Sidekiq auto-retry (3x, 10s intervals)
2. **Provider Error**: Same auto-retry mechanism
3. **All Retries Exhausted**: Manual retry button appears
4. **Manual Retry**: Always succeeds (business rule)

### **User Experience Patterns**

```mermaid
flowchart TD
    A[User Action] --> B{Optimistic UI?}
    B -->|Yes| C[Immediate UI Update]
    B -->|No| D[Show Loading State]
    C --> E[Background Processing]
    D --> E
    E --> F{Success?}
    F -->|Yes| G[Confirm UI State]
    F -->|No| H[Revert + Show Error]
    G --> I[User Continues]
    H --> J[User Retries]
```

### **Data Consistency Patterns**

- **Optimistic Updates**: UI updates immediately, reverts on failure
- **Eventual Consistency**: Background jobs ensure data integrity
- **Conflict Resolution**: Last-write-wins for user actions
- **Audit Trail**: All state changes logged for debugging

---

## 🎯 Key Design Principles

### **User Experience**
- **Immediate Feedback**: Loading states and progress indicators
- **Clear Status**: Color-coded badges and descriptive text
- **Error Recovery**: Always provide next steps for users
- **Accessibility**: Proper ARIA labels and keyboard navigation

### **Technical Excellence**
- **Performance**: Optimized queries and background processing
- **Reliability**: Comprehensive error handling and retries
- **Scalability**: Efficient broadcasting and caching strategies
- **Maintainability**: Clean service architecture and separation of concerns

### **Business Logic**
- **Payment Security**: Retry mechanisms prevent lost revenue
- **Admin Efficiency**: Streamlined prescription generation workflow
- **Patient Satisfaction**: Clear status tracking and communication
- **System Integrity**: Consistent state management across all flows
